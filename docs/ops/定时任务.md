# ⏰ 定时任务

本服务提供多个定时任务，用于自动化维护弹幕库和优化匹配效果。

![定时任务](/screenshot/定时任务.png)

## 任务列表概览

| 任务名称 | 功能 | 默认周期 |
|---------|------|---------|
| TMDB自动刮削与剧集组映射 | 自动刮削别名和剧集组信息 | 每日 |
| 弹幕自动刷新 | 自动刷新弹幕数据 | 每周 |
| 数据库备份 | 自动备份数据库 | 每周 |
| 缓存清理 | 清理过期缓存数据 | 每日 |
| 日志清理 | 清理过期日志文件 | 每周 |

---

## TMDB自动刮削与剧集组映射

### 功能说明

此任务会自动从 TMDB 获取作品的元数据信息，包括：

- **别名刮削**: 获取作品的各语言别名，添加到条目中
- **剧集组映射**: 自动识别和映射 TMDB 的剧集组（Episode Groups）

### 为什么需要别名？

播放器请求弹幕时通常使用文件名进行匹配。不同的命名方式可能导致匹配失败：

- 中文名：`权力的游戏`
- 英文名：`Game of Thrones`
- 简称：`权游`

通过自动刮削别名，可以大幅提高匹配成功率。

### 配置方法

1. 进入 **"设置"** → **"定时任务"**
2. 找到 **"TMDB自动刮削与剧集组映射"** 任务
3. 配置选项：
   - **启用状态**: 开启/关闭任务
   - **执行周期**: 设置执行频率（如每日凌晨3点）
   - **刮削范围**: 全部条目 / 仅缺失别名的条目

### 手动执行

在任务列表中点击 **"立即执行"** 可以手动触发此任务。

---

## 刷新最新集弹幕/定时增量追更

### 功能说明

定期从弹幕源重新获取弹幕数据，确保弹幕库保持最新。

### 刷新策略

- **刷新最新集弹幕**: 只刷新被标记定时的源的最新集
- **定时增量追更**: 尝试获取被标记定时的源的下一集

### 配置方法

1. 进入 **"设置"** → **"定时任务"**
2. 找到 **"刷新最新集弹幕/定时增量追更"** 任务
3. 配置选项：
   - **启用状态**: 开启/关闭任务
   - **执行周期**: 设置执行频率
   - **刷新策略**: 最新集全量刷新 / 增量刷新 
   - **刷新范围**: 被标记定时的源的最新集弹幕 / 被标记定时的源的下一集

---

## 数据库备份任务

### 功能说明

定期自动备份数据库，防止数据丢失，确保系统数据安全。

### 备份内容

数据库备份包含以下所有数据：

- **弹幕库数据**: 所有条目、分集、弹幕内容
- **元数据信息**: TMDB/TVDB 等元数据源的刮削数据
- **系统配置**: 弹幕源配置、用户设置、Token 等
- **任务历史**: 历史任务执行记录
- **访问日志**: API 访问日志和会话记录

### 备份存储

- 备份文件保存在系统持久化目录的 `backups` 子目录中
- 备份文件命名格式：`backup_YYYYMMDD_HHMMSS.sql`（或 `.dump` for PostgreSQL）
- 可以通过 Web UI 的 **"设置"** → **"参数配置"** → **"数据库备份"** 页面下载备份文件

### 配置方法

1. 进入 **"设置"** → **"定时任务"**
2. 找到 **"数据库备份"** 任务
3. 配置选项：
   - **启用状态**: 开启/关闭自动备份
   - **执行周期**: 设置备份频率（建议每周一次）
   - **保留份数**: 保留最近 N 个备份文件，自动删除旧备份

### 手动备份

除了定时自动备份，您也可以随时手动创建备份：

**方式一：通过定时任务**
- 在任务列表中点击 **"立即执行"** 手动触发备份

**方式二：通过参数配置**
- 进入 **"设置"** → **"参数配置"** → **"界面配置"** → **"数据库备份、还原功能"**
- 点击 **"立即备份"** 按钮

### 备份恢复

如需恢复备份，请参考：

1. 进入 **"设置"** → **"参数配置"** → **"界面配置"** → **"数据库备份、还原功能"**
2. 从备份列表中选择要恢复的备份文件
3. 点击 **"还原"** 按钮

> ⚠️ **警告**: 还原操作会覆盖当前所有数据，请谨慎操作！建议还原前先创建当前数据的备份。

### 推荐配置

**个人使用**：
- 执行周期：每周一次
- 保留份数：4-8 个备份（保留 1-2 个月）

**生产环境**：
- 执行周期：每日一次
- 保留份数：14-30 个备份（保留 2 周至 1 个月）

**重要提示**：
- 建议定期将备份文件下载到本地或其他存储位置
- 在系统重大升级或配置变更前，务必手动创建备份
- 定期测试备份恢复功能，确保备份文件可用

---

## 缓存日志清理任务

### 功能说明

清理系统产生的各类缓存数据，释放存储空间。

### 清理范围

- API 响应缓存
- 搜索结果缓存
- 临时文件

### 配置方法

1. 进入 **"设置"** → **"定时任务"**
2. 找到 **"缓存日志清理任务"** 任务
3. 配置选项：
   - **启用状态**: 开启/关闭任务
   - **执行周期**: 设置执行频率
   - **缓存保留天数**: 保留最近N天的缓存

详细说明请参考 **[🧹 缓存日志清理任务说明](/ops/缓存日志清理任务说明)**


---

## 查看任务执行状态

### 任务历史

在 **"任务"** 页面可以查看：

- 任务执行历史记录
- 每次执行的开始时间、结束时间、耗时
- 执行结果（成功/失败）
- 详细日志

### 执行中的任务

正在执行的任务会显示进度条和当前状态。

---

## 📚 相关文档

- **[📚 弹幕库管理](/advanced/弹幕库管理)** - 条目和分集管理
- **[🧹 缓存日志清理](/ops/缓存日志清理任务说明)** - 缓存和日志清理详解
- **[🎬 元数据源配置](/config/元数据源配置)** - TMDB API 配置
- **[⚙️ 设置 - 参数配置](/config/设置#参数配置)** - 数据库备份和还原功能

