# 常见问题

[[toc]]

## 如何重置管理员密码？ { id=reset-password }

::: info 解决方案

如果忘记了管理员密码，可以通过以下步骤重置：

1. 停止容器：
```bash
docker-compose down
```

2. 删除配置文件中的密码记录（或删除整个 config 目录）：
```bash
rm -rf ./config
```

3. 重新启动容器，系统会生成新的初始密码：
```bash
docker-compose up -d
```

4. 查看日志获取新密码：
```bash
docker logs misaka-danmu-server
```

:::

## 数据库占用空间过大怎么办？ { id=database-size }

::: info 解决方案

数据库会随着使用时间增长而变大，可以通过以下方式优化：

**对于 MySQL：**

1. 进入数据库容器：
```bash
docker exec -it danmu-mysql mysql -u danmuapi -p
```

2. 清理旧数据（根据需要调整时间范围）：
```sql
USE danmuapi;
DELETE FROM danmu_cache WHERE created_at < DATE_SUB(NOW(), INTERVAL 30 DAY);
OPTIMIZE TABLE danmu_cache;
```

**对于 PostgreSQL：**

```bash
docker exec -it danmu-postgres psql -U danmuapi -d danmuapi
```

```sql
DELETE FROM danmu_cache WHERE created_at < NOW() - INTERVAL '30 days';
VACUUM FULL;
```

更多优化建议请参考：[MySQL 优化](/ops/MySQL内存优化)

:::

## 海外 VPS 部署后无法访问 TMDB/TVDB 等服务 { id=overseas-vps }

::: warning 网络问题

部分海外 VPS 的 IP 可能被 TMDB、TVDB 等服务封禁，导致无法获取元数据。

:::

::: info 解决方案

1. **更换 VPS 提供商或 IP 地址**
2. **使用代理服务**：在容器中配置 HTTP 代理
3. **使用备用元数据源**：配置多个元数据源作为备份

:::

## TMDB/TVDB API 配置问题 { id=metadata-api }

::: info API 密钥获取

**TMDB API Key：**
1. 访问 [TMDB](https://www.themoviedb.org/)
2. 注册账号并登录
3. 进入 Settings → API → 申请 API Key
4. 选择 "Developer" 类型
5. 填写相关信息后获取 API Key

**TVDB API Key：**
1. 访问 [TVDB](https://thetvdb.com/)
2. 注册账号并登录
3. 进入 Dashboard → API Keys
4. 创建新的 API Key

配置完成后，在 Web UI 的 "元数据源配置" 页面填入对应的 API Key。

详细配置请参考：[元数据源配置](/config/元数据源配置)

:::

## AI 功能无法使用或识别不准确 { id=ai-issues }

::: info 常见问题

**问题 1：AI 服务连接失败**
- 检查 AI API 配置是否正确（API Key、Endpoint）
- 确认网络连接正常
- 查看容器日志排查具体错误

**问题 2：识别准确率低**
- AI 功能依赖于文件名和元数据质量
- 建议先配置好 TMDB/TVDB 等元数据源
- 可以手动修正错误匹配，系统会学习

**问题 3：AI 服务配额用完**
- 检查 API 使用量是否超限
- 考虑升级 API 套餐或更换服务商

详细配置请参考：[AI 功能配置](/config/AI功能配置)

:::

## 如何自定义弹幕存储路径？ { id=custom-storage }

::: info 配置方法

可以通过环境变量或 Web UI 配置自定义存储路径：

**方法 1：环境变量（推荐）**

在 `docker-compose.yaml` 中添加：
```yaml
environment:
  - DANMUAPI_STORAGE__PATH=/custom/path
```

**方法 2：Web UI 配置**

登录后在 "系统设置" → "存储配置" 中修改路径。

**注意**：修改路径后需要重启容器，并确保新路径有正确的读写权限。

:::

## 端口 7768 被占用怎么办？ { id=port-conflict }

::: info 解决方案

修改 `docker-compose.yaml` 中的端口映射：

```yaml
ports:
  - "8080:7768"  # 将主机端口改为 8080 或其他未占用端口
```

然后重启容器：
```bash
docker-compose down
docker-compose up -d
```

访问时使用新端口：`http://<服务器IP>:8080`

:::

## Docker 容器无法启动 { id=container-start-fail }

::: warning 排查步骤

1. **查看容器日志**：
```bash
docker logs misaka-danmu-server
```

2. **检查数据库连接**：
   - 确认数据库容器是否正常运行
   - 检查数据库密码是否正确
   - 验证网络连接

3. **检查文件权限**：
```bash
ls -la ./config ./db-data
```

4. **检查磁盘空间**：
```bash
df -h
```

5. **重新创建容器**：
```bash
docker-compose down
docker-compose up -d
```

:::

## 弹幕无法显示或加载失败 { id=danmu-load-fail }

::: info 排查步骤

1. **检查客户端配置**：
   - 确认弹幕接口地址配置正确
   - 检查 Token 是否有效
   - 参考：[客户端配置](/客户端配置)

2. **检查弹幕源**：
   - 确认已安装弹幕源
   - 检查弹幕源是否正常工作
   - 参考：[弹幕源管理](/advanced/弹幕源管理)

3. **检查媒体匹配**：
   - 在 Web UI 中搜索该媒体
   - 确认是否正确匹配到元数据
   - 手动修正匹配结果

4. **查看日志**：
```bash
docker logs misaka-danmu-server | grep -i error
```

:::

## 如何备份和恢复数据？ { id=backup-restore }

::: info 备份方法

**备份数据库和配置：**

```bash
# 停止服务
docker-compose down

# 备份整个目录
tar -czf misaka-danmu-backup-$(date +%Y%m%d).tar.gz ./config ./db-data

# 重启服务
docker-compose up -d
```

**恢复数据：**

```bash
# 停止服务
docker-compose down

# 解压备份
tar -xzf misaka-danmu-backup-YYYYMMDD.tar.gz

# 重启服务
docker-compose up -d
```

**弹幕源备份：**

在 Web UI 的 "弹幕源管理" 页面可以导出弹幕源配置包，方便迁移和恢复。

:::
