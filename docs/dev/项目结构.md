# ğŸ“ é¡¹ç›®ç»“æ„

## æ ¹ç›®å½•

```
misaka_danmu_server/
â”œâ”€â”€ config/                    # é…ç½®æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ config.yml            # ä¸»é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ logs/                 # æ—¥å¿—ç›®å½•
â”‚   â””â”€â”€ mysql.cnf             # MySQLé…ç½®
â”œâ”€â”€ migrations/                # æ•°æ®åº“è¿ç§»è„šæœ¬
â”œâ”€â”€ src/                       # åç«¯æºä»£ç  (Python/FastAPI)
â”œâ”€â”€ static/                    # é™æ€èµ„æº
â”‚   â””â”€â”€ swagger-ui/           # Swagger UIèµ„æº
â”œâ”€â”€ tools/                     # å·¥å…·è„šæœ¬
â”œâ”€â”€ web/                       # å‰ç«¯æºä»£ç  (React/Vite)
â”œâ”€â”€ Dockerfile                 # Dockeræ„å»ºæ–‡ä»¶
â”œâ”€â”€ docker-compose.yml         # Docker Composeé…ç½®
â”œâ”€â”€ requirements.txt           # Pythonä¾èµ–
â”œâ”€â”€ run.sh                     # å¯åŠ¨è„šæœ¬
â””â”€â”€ README.md                  # é¡¹ç›®è¯´æ˜
```

---

## ğŸ“‚ src/ - åç«¯æºä»£ç 

### æ ¸å¿ƒæ–‡ä»¶

```
src/
â”œâ”€â”€ main.py                    # åº”ç”¨å…¥å£
â”œâ”€â”€ _version.py                # ç‰ˆæœ¬ä¿¡æ¯
â”œâ”€â”€ security.py                # å®‰å…¨è®¤è¯æ¨¡å—
â””â”€â”€ sql.py                     # SQLå·¥å…·
```

### API è·¯ç”±å±‚ (`api/`)

```
src/api/
â”œâ”€â”€ control/                   # æ§åˆ¶é¢æ¿API
â”‚   â”œâ”€â”€ danmaku_routes.py         # å¼¹å¹•ç›¸å…³è·¯ç”±
â”‚   â”œâ”€â”€ import_routes.py          # å¯¼å…¥ç›¸å…³è·¯ç”±
â”‚   â”œâ”€â”€ library_routes.py         # åª’ä½“åº“è·¯ç”±
â”‚   â”œâ”€â”€ settings_routes.py        # è®¾ç½®è·¯ç”±
â”‚   â”œâ”€â”€ task_routes.py            # ä»»åŠ¡è·¯ç”±
â”‚   â””â”€â”€ token_routes.py           # Tokenè·¯ç”±
â”œâ”€â”€ dandan/                    # DandanPlayå…¼å®¹API
â”‚   â”œâ”€â”€ bangumi.py                # ç•ªå‰§API
â”‚   â”œâ”€â”€ comments.py               # å¼¹å¹•è¯„è®ºAPI
â”‚   â”œâ”€â”€ match.py                  # åŒ¹é…API
â”‚   â”œâ”€â”€ search.py                 # æœç´¢API
â”‚   â”œâ”€â”€ danmaku_color.py          # å¼¹å¹•é¢œè‰²å¤„ç†
â”‚   â”œâ”€â”€ danmaku_filter.py         # å¼¹å¹•è¿‡æ»¤
â”‚   â””â”€â”€ danmaku_parser.py         # å¼¹å¹•è§£æ
â”œâ”€â”€ ui/                        # Web UI API
â”‚   â”œâ”€â”€ anime.py                  # ç•ªå‰§ç®¡ç†
â”‚   â”œâ”€â”€ auth.py                   # è®¤è¯
â”‚   â”œâ”€â”€ backup.py                 # å¤‡ä»½ç®¡ç†
â”‚   â”œâ”€â”€ config.py                 # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ danmaku_edit.py           # å¼¹å¹•ç¼–è¾‘
â”‚   â”œâ”€â”€ episode.py                # åˆ†é›†ç®¡ç†
â”‚   â”œâ”€â”€ import_api.py             # å¯¼å…¥API
â”‚   â”œâ”€â”€ local_danmaku.py          # æœ¬åœ°å¼¹å¹•
â”‚   â”œâ”€â”€ media_server.py           # åª’ä½“æœåŠ¡å™¨
â”‚   â”œâ”€â”€ scraper.py                # çˆ¬è™«ç®¡ç†
â”‚   â”œâ”€â”€ search.py                 # æœç´¢
â”‚   â”œâ”€â”€ source.py                 # å¼¹å¹•æºç®¡ç†
â”‚   â””â”€â”€ task.py                   # ä»»åŠ¡ç®¡ç†
â””â”€â”€ webhook_api.py             # Webhook API
```

### AI åŒ¹é…æ¨¡å— (`ai/`)

```
src/ai/
â”œâ”€â”€ ai_matcher.py              # AIåŒ¹é…å™¨
â”œâ”€â”€ ai_matcher_manager.py      # AIåŒ¹é…ç®¡ç†
â”œâ”€â”€ ai_providers.py            # AIæä¾›å•†
â”œâ”€â”€ ai_prompts.py              # AIæç¤ºè¯
â”œâ”€â”€ ai_cache.py                # AIç¼“å­˜
â””â”€â”€ ai_metrics.py              # AIæŒ‡æ ‡
```

### æ•°æ®åº“å±‚ (`db/`)

```
src/db/
â”œâ”€â”€ database.py                # æ•°æ®åº“è¿æ¥
â”œâ”€â”€ orm_models.py              # ORMæ¨¡å‹å®šä¹‰
â”œâ”€â”€ models.py                  # Pydanticæ¨¡å‹
â”œâ”€â”€ migrations.py              # è¿ç§»ç®¡ç†
â”œâ”€â”€ cache_manager.py           # ç¼“å­˜ç®¡ç†
â”œâ”€â”€ config_manager.py          # é…ç½®ç®¡ç†
â”œâ”€â”€ db_maintainer.py           # æ•°æ®åº“ç»´æŠ¤
â””â”€â”€ crud/                      # CRUDæ“ä½œ
    â”œâ”€â”€ anime.py                  # ç•ªå‰§CRUD
    â”œâ”€â”€ episode.py                # åˆ†é›†CRUD
    â”œâ”€â”€ danmaku.py                # å¼¹å¹•CRUD
    â”œâ”€â”€ source.py                 # æºCRUD
    â”œâ”€â”€ user.py                   # ç”¨æˆ·CRUD
    â”œâ”€â”€ config.py                 # é…ç½®CRUD
    â””â”€â”€ task.py                   # ä»»åŠ¡CRUD
```

### å¼¹å¹•çˆ¬å– (`scrapers/`)

```
src/scrapers/
â”œâ”€â”€ base.py                    # çˆ¬å–åŸºç±»
â””â”€â”€ XXXX.py                    # XXXçˆ¬å–
```

### å…ƒæ•°æ®æº (`metadata_sources/`)

```
src/metadata_sources/
â”œâ”€â”€ base.py                    # å…ƒæ•°æ®æºåŸºç±»
â”œâ”€â”€ tmdb.py                    # TMDBå…ƒæ•°æ®
â”œâ”€â”€ tvdb.py                    # TVDBå…ƒæ•°æ®
â”œâ”€â”€ bangumi.py                 # Bangumiå…ƒæ•°æ®
â”œâ”€â”€ douban.py                  # è±†ç“£å…ƒæ•°æ®
â”œâ”€â”€ imdb.py                    # IMDBå…ƒæ•°æ®
â””â”€â”€ 360.py                     # 360å½±è§†å…ƒæ•°æ®
```

### åª’ä½“æœåŠ¡å™¨é›†æˆ (`media_servers/`)

```
src/media_servers/
â”œâ”€â”€ base.py                    # åª’ä½“æœåŠ¡å™¨åŸºç±»
â”œâ”€â”€ emby.py                    # Embyé›†æˆ
â”œâ”€â”€ jellyfin.py                # Jellyfiné›†æˆ
â””â”€â”€ plex.py                    # Plexé›†æˆ
```

### ä¸šåŠ¡æœåŠ¡å±‚ (`services/`)

```
src/services/
â”œâ”€â”€ scraper_manager.py         # çˆ¬å–ç®¡ç†å™¨
â”œâ”€â”€ metadata_manager.py        # å…ƒæ•°æ®ç®¡ç†å™¨
â”œâ”€â”€ media_server_manager.py    # åª’ä½“æœåŠ¡å™¨ç®¡ç†å™¨
â”œâ”€â”€ task_manager.py            # ä»»åŠ¡ç®¡ç†å™¨
â”œâ”€â”€ download_task_manager.py   # ä¸‹è½½ä»»åŠ¡ç®¡ç†å™¨
â”œâ”€â”€ scheduler.py               # è°ƒåº¦å™¨
â”œâ”€â”€ search.py                  # æœç´¢æœåŠ¡
â”œâ”€â”€ name_converter.py          # åç§°è½¬æ¢å™¨
â”œâ”€â”€ title_recognition.py       # æ ‡é¢˜è¯†åˆ«
â”œâ”€â”€ log_manager.py             # æ—¥å¿—ç®¡ç†å™¨
â””â”€â”€ webhook_manager.py         # Webhookç®¡ç†å™¨
```

---

## ğŸ“‚ web/ - å‰ç«¯æºä»£ç 

```
web/
â”œâ”€â”€ index.html                 # HTMLå…¥å£
â”œâ”€â”€ package.json               # NPMé…ç½®
â”œâ”€â”€ vite.config.js             # Viteé…ç½®
â”œâ”€â”€ dist/                      # æ„å»ºè¾“å‡º
â”œâ”€â”€ public/                    # å…¬å…±èµ„æº
â””â”€â”€ src/                       # æºä»£ç 
    â”œâ”€â”€ main.jsx                  # Reactå…¥å£
    â”œâ”€â”€ App.jsx                   # æ ¹ç»„ä»¶
    â”œâ”€â”€ index.css                 # å…¨å±€æ ·å¼ (Tailwind)
    â”œâ”€â”€ ThemeProvider.jsx         # ä¸»é¢˜æä¾›è€… (Ant Design)
    â”œâ”€â”€ MessageContext.jsx        # æ¶ˆæ¯ä¸Šä¸‹æ–‡
    â”œâ”€â”€ ModalContext.jsx          # å¼¹çª—ä¸Šä¸‹æ–‡
    â”‚
    â”œâ”€â”€ apis/                  # APIè°ƒç”¨
    â”‚   â”œâ”€â”€ fetch.js              # è¯·æ±‚å°è£…
    â”‚   â””â”€â”€ index.js              # APIå¯¼å‡º
    â”‚
    â”œâ”€â”€ components/            # é€šç”¨ç»„ä»¶
    â”‚   â”œâ”€â”€ AddSourceModal.jsx        # æ·»åŠ æºå¼¹çª—
    â”‚   â”œâ”€â”€ BatchImportModal.jsx      # æ‰¹é‡å¯¼å…¥å¼¹çª—
    â”‚   â”œâ”€â”€ CreateAnimeModal.jsx      # åˆ›å»ºç•ªå‰§å¼¹çª—
    â”‚   â”œâ”€â”€ DanmakuEditModal.jsx      # å¼¹å¹•ç¼–è¾‘å¼¹çª—
    â”‚   â”œâ”€â”€ DarkModeToggle.jsx        # æ·±è‰²æ¨¡å¼åˆ‡æ¢
    â”‚   â”œâ”€â”€ ResponsiveModal.jsx       # å“åº”å¼å¼¹çª—
    â”‚   â”œâ”€â”€ ResponsiveTable.jsx       # å“åº”å¼è¡¨æ ¼
    â”‚   â”œâ”€â”€ SortablePriorityList.jsx  # å¯æ‹–æ‹½ä¼˜å…ˆçº§åˆ—è¡¨
    â”‚   â””â”€â”€ VersionModal.jsx          # ç‰ˆæœ¬å¼¹çª—
    â”‚
    â”œâ”€â”€ general/               # å¸ƒå±€ç»„ä»¶
    â”‚   â”œâ”€â”€ Layout.jsx            # ä¸»å¸ƒå±€
    â”‚   â”œâ”€â”€ Header.jsx            # å¤´éƒ¨
    â”‚   â”œâ”€â”€ Router.jsx            # è·¯ç”±é…ç½®
    â”‚   â””â”€â”€ NotFound.jsx          # 404é¡µé¢
    â”‚
    â”œâ”€â”€ pages/                 # é¡µé¢ç»„ä»¶
    â”‚   â”œâ”€â”€ home/                 # é¦–é¡µ
    â”‚   â”œâ”€â”€ anime/                # ç•ªå‰§è¯¦æƒ…é¡µ
    â”‚   â”œâ”€â”€ episode/              # åˆ†é›†è¯¦æƒ…é¡µ
    â”‚   â”œâ”€â”€ source/               # å¼¹å¹•æºç®¡ç†
    â”‚   â”œâ”€â”€ bullet/               # å¼¹å¹•ç®¡ç†
    â”‚   â”œâ”€â”€ task/                 # ä»»åŠ¡ç®¡ç†
    â”‚   â”œâ”€â”€ media-fetch/          # åª’ä½“è·å–
    â”‚   â”œâ”€â”€ library/              # åª’ä½“åº“
    â”‚   â”œâ”€â”€ setting/              # è®¾ç½®é¡µ
    â”‚   â”œâ”€â”€ control/              # æ§åˆ¶é¢æ¿
    â”‚   â””â”€â”€ login/                # ç™»å½•é¡µ
    â”‚
    â”œâ”€â”€ hooks/                 # è‡ªå®šä¹‰Hooks
    â”‚   â”œâ”€â”€ useDebounce.js        # é˜²æŠ–Hook
    â”‚   â””â”€â”€ useScroll.js          # æ»šåŠ¨Hook
    â”‚
    â””â”€â”€ utils/                 # å·¥å…·å‡½æ•°
        â”œâ”€â”€ data.js               # æ•°æ®å¤„ç†
        â””â”€â”€ localstroage.js       # æœ¬åœ°å­˜å‚¨
```


---

## ğŸ“ å…³é”®æ–‡ä»¶è¯´æ˜

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `src/main.py` | FastAPIåº”ç”¨å…¥å£ï¼Œæ³¨å†Œæ‰€æœ‰è·¯ç”±å’Œä¸­é—´ä»¶ |
| `src/db/orm_models.py` | SQLAlchemy ORMæ¨¡å‹å®šä¹‰ |
| `src/db/models.py` | Pydanticæ•°æ®æ¨¡å‹ |
| `src/scrapers/base.py` | å¼¹å¹•åŸºç±»ï¼Œå®šä¹‰çˆ¬å–æ¥å£ |
| `src/services/scraper_manager.py` | çˆ¬å–ç®¡ç†å™¨ï¼Œç»Ÿä¸€ç®¡ç†æ‰€æœ‰å¼¹å¹•æº |
| `web/src/ThemeProvider.jsx` | Ant Designä¸»é¢˜é…ç½®ï¼ˆäº®è‰²/æ·±è‰²ï¼‰ |
| `web/src/index.css` | Tailwind CSSå…¨å±€æ ·å¼å’ŒCSSå˜é‡ |

---

## ğŸ¨ ä¸»é¢˜é…è‰²

### CSSå˜é‡å®šä¹‰ (`web/src/index.css`)

| å˜é‡ | äº®è‰²æ¨¡å¼ | æ·±è‰²æ¨¡å¼ | è¯´æ˜ |
|------|----------|----------|------|
| `--color-bg` | `#fff9fb` | `#0f172a` | é¡µé¢èƒŒæ™¯ |
| `--color-card` | `#ffffff` | `#1e293b` | å¡ç‰‡èƒŒæ™¯ |
| `--color-hover` | `#fff0f5` | `#273449` | æ‚¬åœ/é«˜äº®èƒŒæ™¯ |
| `--color-primary` | `#ff6b9b` | `#ff6b9b` | ä¸»é¢˜è‰²ï¼ˆç²‰è‰²ï¼‰ |
| `--color-border` | `#ffd9e5` | `#334155` | è¾¹æ¡†é¢œè‰² |
| `--color-text` | `#333333` | `#f8fafc` | ä¸»æ–‡å­—é¢œè‰² |

---

::: tip æç¤º
å¦‚éœ€æ·»åŠ æ–°çš„å¼¹å¹•æºï¼Œè¯·å‚è€ƒ `src/scrapers/base.py` ä¸­çš„åŸºç±»å®šä¹‰ï¼Œå¹¶åœ¨ `src/services/scraper_manager.py` ä¸­æ³¨å†Œæ–°çš„çˆ¬è™«ã€‚
:::

